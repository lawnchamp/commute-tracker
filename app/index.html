<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"> 
    <script src='https://cdn.firebase.com/js/client/2.2.1/firebase.js'></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>
    <script src="https://maps.google.com/maps/api/js?sensor=false"></script>
</head>
    <body>
        <div id='messagesDiv'></div>
        <div id="map" style="width: 500px; height: 400px;"></div>
        <input type='text' id='nameInput' placeholder='Name'>
        <button type="button" onclick=startTracking()>Track Location</button>
        <button type="button" onclick=stopTracking()>Stop Tracking</button>

        <script>

            var myDataRef = new Firebase('commute-watcher.firebaseIO.com');
            var loop_id
            var locations = [];
            var map = new google.maps.Map(document.getElementById('map'), {
                        zoom: 10,
                        center: new google.maps.LatLng(38.92191547761346, -77.23441596452001),
                        mapTypeId: google.maps.MapTypeId.ROADMAP,
                        mapTypeControl: false,
                        streetViewControl: false,
                        panControl: false,
                        zoomControlOptions: {
                            position: google.maps.ControlPosition.LEFT_BOTTOM
                        }
            });
            var infowindow = new google.maps.InfoWindow({
                maxWidth: 160
            });
            function startTracking() {
                console.log("getting location");
                navigator.geolocation.getCurrentPosition(storeCoords);
                loop_id = setTimeout( function() {startTracking()}, 5000);
            }

            function stopTracking() {
                console.log("Stopping tracking");
                clearTimeout(loop_id);
            }
            
            function storeCoords(location) {
                var locationInfo = [$('#nameInput').val(),
                                       location.coords.latitude, 
                                       location.coords.longitude, 
                                       location.timestamp];
                locations.push(locationInfo);
                var date = new Date(locationInfo[3]);
                displayChatMessage(locationInfo[0], locationInfo[1], locationInfo[2], date.toLocaleTimeString());
                myDataRef.push({name: locationInfo[0], 
                                latitude: locationInfo[1], 
                                longitude: locationInfo[2], 
                                time: locationInfo[3]});
            }

            myDataRef.on('child_added', function(snapshot) {
                //var data = snapshot.val();
                //var date = new Date(data.time);
                console.log("got new data with name: " + snapshot.val().name)
                //displayChatMessage(data.name, data.latitude, data.longitude, date.toLocaleTimeString());
            });

            function displayChatMessage(name, latitude, longitude, time) {
                $('<div/>').prepend($('<em/>').text(name+': ' + 
                    " " + latitude + " " + longitude + 
                    " " + time)).appendTo($('#messagesDiv'));
                $('#messagesDiv')[0].scrollTop = $('#messagesDiv')[0].scrollHeight;
            };
        </script>
    </body>
</html>
